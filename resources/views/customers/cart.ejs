<section class="cart py-16">
  <% if(session.cart) { %>

  <div class="order container mx-auto max-w-4xl px-4">
    <!-- Header -->
    <div class="flex items-center border-b border-gray-300 pb-4">
      <img class="w-8" src="/img/cart-black.png" alt="">
      <h1 class="font-bold ml-4 text-2xl">Order Summary</h1>
    </div>

    <!-- Pizza List -->
    <div class="pizza-list">
      <% for(let pizza of Object.values(session.cart.items)) { %>

      <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4 my-6 border-b pb-4">
        <!-- Image -->
        <img class="w-24" src="/img/<%= pizza.items.image %>" alt="">

        <!-- Details -->
        <div class="flex-1 text-center sm:text-left">
          <h1 class="font-bold"><%= pizza.items.name %></h1>
          <span class="text-gray-500 text-sm"><%= pizza.items.size %></span>
        </div>

        <!-- Quantity -->
        <span class="font-semibold">Qty: <%= pizza.qty %></span>

        <!-- Price -->
        <span class="font-bold text-lg">
          â‚¹<%= pizza.items.price * pizza.qty %>
        </span>

        <!-- Remove Button -->
        <button
          class="remove-item text-red-600 font-bold hover:underline"
          data-id="<%= pizza.items._id %>"
          data-size="<%= pizza.items.size %>">
          Remove
        </button>
      </div>

      <% } %>
    </div>

    <!-- Total -->
    <div class="text-right py-6">
      <span class="text-lg font-bold">Total Amount:</span>
      <span class="amount text-2xl font-bold ml-2">
        â‚¹<%= session.cart.totalPrice %>
      </span>
    </div>

    <!-- Order / Login -->
    <% if(user) { %>
      <form action="/orders" method="POST" class="mt-6 flex flex-col items-center">
        <input
          name="phone"
          class="border border-gray-400 p-2 w-full sm:w-1/2 mb-4"
          type="text"
          placeholder="Phone number">

        <input
          name="address"
          class="border border-gray-400 p-2 w-full sm:w-1/2 mb-4"
          type="text"
          placeholder="Address">

        <button
          class="btn-primary px-6 py-2 rounded-full text-white font-bold mt-4"
          type="submit">
          Order Now
        </button>
      </form>
    <% } else { %>
      <div class="text-center mt-6">
        <a href="/login"
           class="inline-block btn-primary px-6 py-2 rounded-full text-white font-bold">
          Login to Continue
        </a>
      </div>
    <% } %>
  </div>

  <% } else { %>

  <!-- Empty Cart -->
  <div class="container mx-auto text-center px-4">
    <h1 class="text-3xl font-bold mb-2">Cart Empty ðŸ˜•</h1>
    <p class="text-gray-500 text-lg mb-12">
      You probably haven't ordered a pizza yet.
    </p>

    <img class="w-3/4 sm:w-2/5 mx-auto" src="/img/empty-cart.png" alt="empty-cart">

    <a href="/"
       class="inline-block px-6 py-2 rounded-full btn-primary text-white font-bold mt-12">
      Go back
    </a>
  </div>

  <% } %>
</section>

<!-- âœ… FIXED JS (Event Delegation) -->
<script>
  document.addEventListener('click', async function (e) {
    const button = e.target.closest('.remove-item')
    if (!button) return

    const id = button.dataset.id
    const size = button.dataset.size

    try {
      const res = await fetch('/remove-from-cart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        body: JSON.stringify({ id, size })
      })

      const data = await res.json()
      if (data.success) {
        window.location.reload()
      }
    } catch (err) {
      console.error('Failed to remove item', err)
    }
  })
</script>
